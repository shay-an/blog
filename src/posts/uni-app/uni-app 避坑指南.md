---
title: uni-app 避坑指南
cover: /assets/images/cover2.jpg
icon: pen-to-square
date: 2023-09-05
category:
  - 避坑指南
tag:
  - uni-app
  - vue
star: false
sticky: false
---

### “开发一次，多端覆盖”

前端碎片化比较严重的今天，uni-app 做为一个跨端开发方案，“开发一次，多端覆盖” uni-app 在官网是这么宣传的，这句话其实也没问题，当然与理想的一套代码，多端运行还是有一定距离的，或者说是几乎不能实现的。

### 条件编译

条件编译看起来有点像 c 语言的宏，也是编译时运行，不过条件编译语法非常简单：

写法： 以 #ifdef 或 #ifndef 加 %PLATFORM% 开头，以 #endif 结尾。

例如：
```javascript
// #ifdef APP-PLUS
需条件编译的代码
// #endif
```

```html
 <!-- #ifdef APP-PLUS -->
需条件编译的代码
 <!-- #endif -->
```

```css
/* #ifdef APP-PLUS */
需条件编译的代码
/* #endif */
```
这个方式几乎覆盖了各种文件，pages.json 都支持，不过如果条件编译代码过于复杂，代码就会看起来特别臃肿，而且也不方便测试，最好是将这种代码封装到一个方法内，调用这个方法的地方就可以看起来比较干净。

如果有大段的代码需要写条件编译就建议按平台封装组件，将组件按平台引入并注册，将通用逻辑以mixin的形式封装并复用。

或者这个页面本身就是该平台特有的页面可以在pages.json里就可以按平台写条件编译注册。

### 小程序

一般小程序都有包体限制，使用 uni-app 会有一个运行时，在小程序代码依赖分析里能看到 vendor.js 的文件，Vue2 版本有近400k Vue3 版本会有 近 200k，而且不能分包，用微信的标准首包建议 1.5M 一下，留给开发者的空间就只剩 1M 多一点的空间，尤其首页tab业务比较复杂时，如果静态资源比较多，就不太好处理，只能放 cdn，这样就增加了运营成本。好在分包在H5无效，这样在兼容两端时这部分不用考虑。

开发体验较差，尤其我之前维护的一个项目时使用cli创建的 Vue2 项目，如果使用 run dev 生成的小程序代码包体过大，无法真机预览，如果使用 run build 编译速度太慢，每次保存都要等大几十秒，效率是真的低。建议开发时顺序是：优先调试H5，然后build之后在真机上适配，如果是微信上特有的业务优先使用run dev 在开发者模拟器中调试，如果是真机特有API建议先mock数据先在模拟器上调试，等没有问题了再到真机上联调API，节省开发成本。不过uni-app支持了Vue3，建议新项目直接使用Vue3，开发体验能好不少。

### APP

如果选择兼容APP建议一开始就考虑预留，不然从其他平台兼容APP会非常困难！！！如果使用nvue限制更多，最大的区别是nvue页面只支持 class 选择器，而且不支持子选择器。nvue 和普通 vue 文件在动画、获取元素等API也不一样，因为nvue底层是 weex渲染，vue是webview渲染，所以 uni-app “贴心的”支持了APP APP-PLUS APP-PLUS-NVUE 平台的条件编译！

APP 上面临的是一堆bug，而且偶尔有少量API不符合预期的情况，需要密切关注官方问答社区或加官方群 非官方群寻求帮助（尽量多渠道了解）。有的时候使用 uni 命名空间下的api有问题，可以使用plus命名空间下的api解决问题！参考文档 https://www.html5plus.org/doc/

而且 Android 和 Ios 也有差异，其实普通.vue文件还行，webview平台差异不算大，nvue 由于使用了目标平台的原生组件，会存在无法兼容的问题，同样也贴心的准备了 APP-ANDROID APP-IOS 条件编译。

不要完全对标原生APP，虽然支持自定义原生组件，但某些需求肯定是实现不了的，一般 uni-app 自带的组件能实现的需求可以大胆的接，插件市场有的组件、插件试用没有问题的能实现的需求也可以大胆的接，如果产品拿来原生APP的一个效果要实现，你在uni-app官方资料中没有见过，就要小心一点，能变需求就变需求，千万别钻牛角尖，最终能实现业务就行！另外js与原生通信看文档感觉就是JSON传递，所以需要用到操作byte的需求可能也无法实现，这个我没有详细考证[狗头]。

开发建议：只要不是对性能要求高的场景尽量使用.vue，更符合直觉，如果首页及相关tab 对于的页面可以尝试使用nvue，制定开发计划对兼容性调试要有预留！长列表一定要使用nvue，可以是用 list + ceil 优化内存，要兼容H5、小程序就得自己找虚拟列表组件实现。

### QA测试建议

如果时间比较紧赶时间建议：单个平台执行完整的测试用例及流程测试，特有平台特有功能一定是完整测试流程，其他平台可以只走流程测试，主要看平台兼容性，如果使用了条件编译就建议走完整测试，毕竟谁也不能保证每个分支不出问题。

### 总结

综合来看，uni-app 只是在一般场景下可以实现一套代码，多端运行，最重要的是各个平台API不一致导致的，而且也没有办法抹平平台差异，只能说看项目规划，结合特性，需要认真规划，总之开发时考虑的维度会增加（会比较消耗脑力）。

如果只是当作特定平台的开发框架也是一种选择，如H5用上了 rpx 单位用于适配，增加了页面的概念，增加了页面特有的生命周期等，对于开发Vue移动端H5应用也能提升开发效率。小程序就要考虑运行时代码有没有影响，当然有了uni-app编译这一步，也有好处，比如可以实现小程序不支持的全局组件等。

最后一定要保证代码可读性！

参考文献 https://juejin.cn/post/7255855818595647546